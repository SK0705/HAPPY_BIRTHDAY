<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>For Someone Special ðŸ’«</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

/* Mobile optimization: allow scrolling for long messages but hide horizontal overflow */
html, body {
  height: 100%;
  background: #000;
  font-family: 'Montserrat', sans-serif;
  overflow-x: hidden;
  color: #fff;
  -webkit-tap-highlight-color: transparent;
}

/* Background stays fixed */
#container {
  position: fixed;
  inset: 0;
  z-index: 0;
}

.overlay {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle, rgba(0,255,200,.1), rgba(0,0,0,.85));
  opacity: 0;
  transition: opacity 1.5s ease;
  pointer-events: none;
  z-index: 1;
}
.overlay.active { opacity: 1; }

/* Content wrapper that allows scrolling on mobile */
.center {
  position: relative;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 2;
  padding: 2rem 1rem;
}

.hidden { display: none !important; }

/* UI Boxes - Mobile Optimized width and glass effect */
#namePrompt, #birthdayMessage {
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  padding: 2rem 1.5rem;
  border-radius: 24px;
  text-align: center;
  box-shadow: 0 0 40px rgba(0, 255, 200, 0.2);
  width: 100%;
  max-width: 380px;
  border: 1px solid rgba(0, 255, 213, 0.2);
}

#namePrompt h2 {
  font-size: 1.4rem;
  margin-bottom: 1rem;
  background: linear-gradient(to right, #00ffd5, #6a5acd);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

input {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #00ffd5;
  background: rgba(255,255,255,0.05);
  color: #fff;
  font-size: 1rem;
  text-align: center;
  margin-bottom: 1rem;
  outline: none;
}

button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(45deg, #00ffd5, #6a5acd);
  color: #000;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: transform 0.2s;
}
button:active { transform: scale(0.95); }

/* Countdown */
#timer {
  font-family: 'Dancing Script', cursive;
  font-size: 5rem;
  color: #00ffd5;
  text-shadow: 0 0 20px rgba(0,255,213,0.5);
  animation: pulse 1s infinite alternate;
}
@keyframes pulse { to { transform: scale(1.15); } }

/* Message Typography */
.line {
  font-size: 1.15rem;
  line-height: 1.6;
  margin-bottom: 10px;
  opacity: 0;
  transform: translateY(20px);
  animation: lineIn 0.8s forwards;
}

.highlight { color: #00ffd5; font-weight: bold; }

.nameStyle {
  font-family: 'Pacifico', cursive;
  font-size: 1.8rem;
  color: #00ffd5;
  display: block;
  margin: 15px 0;
}

.final-line {
  margin-top: 20px;
  font-size: 0.95rem;
  font-style: italic;
  opacity: 0;
  animation: lineIn 1s forwards 2.5s;
}

.signature {
  font-family: 'Dancing Script', cursive;
  font-size: 1.8rem;
  margin-top: 15px;
  opacity: 0;
  animation: lineIn 1s forwards 3.2s;
}

#finalImage {
  display: none;
  margin-top: 1.5rem;
}
#finalImage img {
  width: 100%;
  max-width: 240px;
  border-radius: 15px;
  box-shadow: 0 0 25px rgba(0, 255, 200, 0.4);
}

@keyframes lineIn { to { opacity: 1; transform: translateY(0); } }
</style>
</head>

<body>

<div id="container"></div>
<div class="overlay"></div>

<div id="nameScreen" class="center">
  <div id="namePrompt">
    <h2>Enter your beautiful name âœ¨</h2>
    <input id="nameInput" type="text" placeholder="Your name..." aria-label="Name">
    <button id="startBtn">Begin Experience</button>
  </div>
</div>

<div id="countdownScreen" class="center hidden">
  <div style="text-align:center">
    <h2 style="margin-bottom:1rem">Hey <span id="nameDisplay"></span>...</h2>
    <div id="timer">3</div>
  </div>
</div>

<div id="messageScreen" class="center hidden">
  <div id="birthdayMessage">
    <div class="line" style="animation-delay: 0.2s">Many more happy returns to the young lady</div>
    <div class="line" style="animation-delay: 0.4s">with a smile that disarms</div>
    <div class="line" style="animation-delay: 0.6s">and eyes that carry the power of <span class="highlight">kintsugi</span> â€”</div>
    <div class="line" style="animation-delay: 0.8s">strength in beauty.</div>
    <div class="line" style="animation-delay: 1.0s"><strong>Happy Birthday, <span class="nameStyle" id="finalName"></span></strong></div>
    <div class="line" style="animation-delay: 1.2s">To the one whose laughter lingers</div>
    <div class="line" style="animation-delay: 1.4s">long after the moment passes.</div>
    <div class="final-line">May your day be as beautiful as the light you bring to others</div>
    <div class="signature">With magic âœ¨</div>

    <div id="finalImage">
      <img src="Happy Birthday.png" alt="Happy Birthday">
    </div>
  </div>
</div>

<audio id="bgMusic" loop>
  <source src="BGM.mp3" type="audio/mpeg">
</audio>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

const THEME = 'cosmic'; 
const COLORS = { cosmic: 0x6a5acd, emerald: 0x00ff7f };

const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
const COUNT = isMobile ? 4000 : 9000; // Lowered for mobile performance

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.z = isMobile ? 110 : 90; // Pull back camera on mobile

const renderer = new THREE.WebGLRenderer({ antialias: !isMobile });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
document.getElementById("container").appendChild(renderer.domElement);

const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.4, 0.7, 0.7);
composer.addPass(bloom);

let audioCtx, analyser, data, audioReady = false;
const music = document.getElementById("bgMusic");

function initAudio() {
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaElementSource(music);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    data = new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser);
    analyser.connect(audioCtx.destination);
    audioReady = true;
  } catch(e) { console.error("Audio init failed", e); }
}

function star(i, n) {
  let a = i / n * Math.PI * 2;
  return new THREE.Vector3(Math.cos(a) * 35, Math.sin(a) * 35, Math.sin(a * 4) * 3);
}
function target(i, n) {
  let t = i / n * Math.PI * 2;
  return new THREE.Vector3(Math.cos(t) * 20, Math.sin(t) * 20, Math.sin(t * 6) * 6);
}

const geo = new THREE.BufferGeometry();
const pos = new Float32Array(COUNT * 3);
const from = new Float32Array(COUNT * 3);
const to = new Float32Array(COUNT * 3);

for(let i = 0; i < COUNT; i++) {
  const s = star(i, COUNT);
  const t = target(i, COUNT);
  from.set([s.x, s.y, s.z], i * 3);
  to.set([t.x, t.y, t.z], i * 3);
  pos.set([s.x, s.y, s.z], i * 3);
}
geo.setAttribute("position", new THREE.BufferAttribute(pos, 3));
geo.setAttribute("from", new THREE.BufferAttribute(from, 3));
geo.setAttribute("to", new THREE.BufferAttribute(to, 3));

const mat = new THREE.PointsMaterial({
  size: isMobile ? 1.8 : 2.4,
  color: COLORS[THEME],
  transparent: true,
  blending: THREE.AdditiveBlending
});
scene.add(new THREE.Points(geo, mat));

let reveal = 0;
const speed = 0.0005;
const edgeWidth = 0.1;

function animate() {
  requestAnimationFrame(animate);
  let beat = 0;
  if(audioReady) {
    analyser.getByteFrequencyData(data);
    let sum = 0;
    for(let i = 2; i < 30; i++) sum += data[i];
    beat = sum / 28 / 255;
  }

  reveal = Math.min(1, reveal + speed + beat * 0.01);
  bloom.strength = 0.3 + beat * 1.5;
  mat.size = (isMobile ? 1.6 : 2.2) + beat * 2;

  const p = geo.attributes.position.array;
  for(let i = 0; i < COUNT; i++) {
    const i3 = i * 3;
    const t = i / COUNT;
    const d = t - reveal;
    let m = 0;
    if(d < 0 && d > -edgeWidth) {
      m = THREE.MathUtils.smoothstep(1 + d / edgeWidth, 0, 1);
      p[i3 + 2] += Math.sin((reveal - t) * 50) * beat * 5;
    } else if(d <= -edgeWidth) { m = 1; }

    p[i3] += (THREE.MathUtils.lerp(from[i3], to[i3], m) - p[i3]) * 0.12;
    p[i3+1] += (THREE.MathUtils.lerp(from[i3+1], to[i3+1], m) - p[i3+1]) * 0.12;
    p[i3+2] += (THREE.MathUtils.lerp(from[i3+2], to[i3+2], m) - p[i3+2]) * 0.12;
  }

  geo.attributes.position.needsUpdate = true;
  composer.render();
}
animate();

/* UI FLOW */
document.getElementById("startBtn").onclick = () => {
  const name = document.getElementById("nameInput").value.trim();
  if(!name) return alert("Please enter your beautiful name!");

  document.getElementById("nameDisplay").textContent = name;
  document.getElementById("finalName").textContent = `${name.toUpperCase()}`;

  if(!audioCtx) initAudio();
  if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
  music.play().catch(e => console.log("Playback blocked"));

  document.getElementById("nameScreen").classList.add("hidden");
  document.getElementById("countdownScreen").classList.remove("hidden");

  let c = 3;
  const timer = document.getElementById("timer");
  const iv = setInterval(() => {
    c--; 
    if(c > 0) timer.textContent = c;
    if(c <= 0) {
      clearInterval(iv);
      document.getElementById("countdownScreen").classList.add("hidden");
      document.getElementById("messageScreen").classList.remove("hidden");
      document.querySelector(".overlay").classList.add("active");
      window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 } });
      
      // Delay image showing to let text be read
      setTimeout(() => {
        const imgDiv = document.getElementById("finalImage");
        imgDiv.style.display = "block";
      }, 4000);
    }
  }, 1000);
};

window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  composer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
