<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>For Someone Special ðŸ’«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js"
      }
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --accent: #ff007f; --glow: #7a00ff; }
        
        body, html { 
            background: #000; color: #fff; font-family: 'Montserrat', sans-serif; 
            overflow: hidden; height: 100%; width: 100%; position: fixed;
        }

        canvas.webgl { position: fixed; top: 0; left: 0; z-index: 1; outline: none; touch-action: none; }

        .ui-layer {
            position: absolute; z-index: 10; top: 0; left: 0; height: 100%; width: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: none; padding: 20px;
        }
        .interactive { pointer-events: auto; }

        .glass-box {
            background: rgba(15, 0, 25, 0.75); backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 0, 127, 0.3);
            padding: 2rem 1.5rem; border-radius: 25px; text-align: center;
            width: 100%; max-width: 350px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        input {
            width: 100%; padding: 18px; border-radius: 15px; border: 1.5px solid var(--accent);
            background: rgba(0,0,0,0.5); color: #fff; margin-bottom: 20px; 
            text-align: center; font-size: 16px; /* Prevents iOS zoom on focus */
        }

        .btn-glow {
            width: 100%; padding: 18px; border-radius: 15px; border: none;
            background: linear-gradient(45deg, var(--accent), var(--glow)); color: #fff;
            font-weight: 700; cursor: pointer; letter-spacing: 1px; font-size: 14px;
            box-shadow: 0 4px 15px rgba(255, 0, 127, 0.3);
        }

        #timer { font-family: 'Dancing Script'; font-size: 6rem; color: var(--accent); text-shadow: 0 0 20px var(--accent); }

        .message-content { opacity: 0; transform: translateY(30px); }
        .line { font-size: 0.95rem; line-height: 1.6; margin-bottom: 8px; }
        .nameStyle { 
            font-family: 'Pacifico', cursive; font-size: 1.8rem; color: var(--accent); 
            display: block; margin: 10px 0; text-shadow: 0 0 10px var(--accent);
        }
        .highlight { color: #d4af37; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<canvas class="webgl"></canvas>

<div class="ui-layer interactive" id="mainUI">
    <div id="screen-name" class="glass-box">
        <h2 style="margin-bottom:15px; color: #ff007f; font-size: 1.4rem;">For Someone Special âœ¨</h2>
        <input type="text" id="userName" placeholder="Enter her name..." autocomplete="off">
        <button class="btn-glow" id="btnBegin">OPEN THE UNIVERSE</button>
    </div>

    <div id="screen-timer" class="hidden">
        <div id="timer">3</div>
    </div>

    <div id="screen-message" class="glass-box hidden">
        <div class="message-content">
            <div class="line">Many more happy returns to the young lady</div>
            <div class="line">with a smile that disarms and eyes that carry</div>
            <div class="line">the power of <span class="highlight">kintsugi</span> â€” strength in beauty.</div>
            <span class="nameStyle" id="displayName"></span>
            <div class="line">May your day be as beautiful as the light you bring.</div>
            <div style="font-family: 'Dancing Script'; font-size: 1.8rem; color: var(--accent);">With magic âœ¨</div>
        </div>
    </div>
</div>

<audio id="bgMusic" loop preload="auto"><source src="BGM.mp3" type="audio/mpeg"></audio>

<script type="module">
import * as THREE from 'three';

// Detect Mobile for Optimization
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

const canvas = document.querySelector('canvas.webgl');
const scene = new THREE.Scene();

const parameters = {
    count: isMobile ? 45000 : 100000, // Reduced for mobile performance
    size: isMobile ? 0.018 : 0.012,    // Slightly larger particles for visibility
    radius: 5,
    branches: 3,
    spin: 1.2,
    randomness: 0.25,
    randomnessPower: 3,
    insideColor: '#ff007f', 
    outsideColor: '#2b0c52'
};

const geometry = new THREE.BufferGeometry();
const positions = new Float32Array(parameters.count * 3);
const colors = new Float32Array(parameters.count * 3);

const galaxyTarget = new Float32Array(parameters.count * 3);
const cakeTarget = new Float32Array(parameters.count * 3);

const colorInside = new THREE.Color(parameters.insideColor);
const colorOutside = new THREE.Color(parameters.outsideColor);

for(let i = 0; i < parameters.count; i++) {
    const i3 = i * 3;
    const radius = Math.random() * parameters.radius;
    const branchAngle = (i % parameters.branches) / parameters.branches * Math.PI * 2;
    const spinAngle = radius * parameters.spin;

    // Galaxy Data
    galaxyTarget[i3] = Math.cos(branchAngle + spinAngle) * radius + (Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 0.3 * radius);
    galaxyTarget[i3 + 1] = (Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 0.3 * radius);
    galaxyTarget[i3 + 2] = Math.sin(branchAngle + spinAngle) * radius + (Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 0.3 * radius);

    // Cake Data
    let r, h, isFlame = false;
    const rand = Math.random();
    if (rand < 0.8) { // Body
        const layer = Math.random();
        if (layer < 0.5) { r = 2.2; h = Math.random() * 1.4; }
        else if (layer < 0.8) { r = 1.6; h = 1.4 + Math.random() * 1.1; }
        else { r = 1.0; h = 2.5 + Math.random() * 0.8; }
        const angle = Math.random() * Math.PI * 2;
        cakeTarget[i3] = Math.cos(angle) * r;
        cakeTarget[i3 + 1] = h - 1.2;
        cakeTarget[i3 + 2] = Math.sin(angle) * r;
    } else if (rand < 0.9) { // Candles
        const cx = [0, 0.5, -0.5][i % 3];
        const cz = [0.4, -0.2, -0.2][i % 3];
        cakeTarget[i3] = cx;
        cakeTarget[i3 + 1] = 3.3 + (Math.random() * 0.8) - 1.2;
        cakeTarget[i3 + 2] = cz;
    } else { // Flames
        isFlame = true;
        const cx = [0, 0.5, -0.5][i % 3];
        const cz = [0.4, -0.2, -0.2][i % 3];
        cakeTarget[i3] = cx + (Math.random()-0.5)*0.1;
        cakeTarget[i3 + 1] = 4.1 + (Math.random() * 0.3) - 1.2;
        cakeTarget[i3 + 2] = cz + (Math.random()-0.5)*0.1;
    }

    positions[i3] = galaxyTarget[i3];
    positions[i3+1] = galaxyTarget[i3+1];
    positions[i3+2] = galaxyTarget[i3+2];

    const mix = isFlame ? new THREE.Color('#ffaa00') : colorInside.clone().lerp(colorOutside, radius/5);
    colors[i3] = mix.r; colors[i3+1] = mix.g; colors[i3+2] = mix.b;
}

geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

const material = new THREE.PointsMaterial({
    size: parameters.size,
    sizeAttenuation: true,
    depthWrite: false,
    blending: THREE.AdditiveBlending,
    vertexColors: true
});

const points = new THREE.Points(geometry, material);
scene.add(points);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
camera.position.set(0, 3, 7);
const renderer = new THREE.WebGLRenderer({ canvas, antialias: !isMobile }); // Antialias off on mobile for speed
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

function animate() {
    points.rotation.y += 0.0015;
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
}
animate();

const btnBegin = document.getElementById('btnBegin');
const bgMusic = document.getElementById('bgMusic');

btnBegin.onclick = () => {
    const name = document.getElementById('userName').value.trim();
    if(!name) return alert("Please enter her name âœ¨");
    document.getElementById('displayName').innerText = name;
    bgMusic.play().catch(() => {}); // Handle browser audio block
    
    gsap.to('#screen-name', { opacity: 0, duration: 0.8, onComplete: () => {
        document.getElementById('screen-name').classList.add('hidden');
        document.getElementById('screen-timer').classList.remove('hidden');
        let c = 3;
        const t = setInterval(() => {
            c--;
            if(c>0) document.getElementById('timer').innerText = c;
            else { 
                clearInterval(t); 
                document.getElementById('screen-timer').classList.add('hidden');
                morph(); 
            }
        }, 1000);
    }});
};

function morph() {
    const pos = points.geometry.attributes.position.array;
    for(let i=0; i<parameters.count; i++) {
        const i3 = i*3;
        gsap.to(pos, {
            [i3]: cakeTarget[i3], [i3+1]: cakeTarget[i3+1], [i3+2]: cakeTarget[i3+2],
            duration: 4, ease: "power2.inOut", delay: Math.random() * 0.5,
            onUpdate: () => points.geometry.attributes.position.needsUpdate = true
        });
    }
    gsap.to(camera.position, { x: 0, y: 1, z: isMobile ? 9 : 7, duration: 5 });
    setTimeout(final, 6500);
}

function final() {
    document.getElementById('screen-message').classList.remove('hidden');
    gsap.to('.message-content', { opacity: 1, y: 0, duration: 1.5 });
    window.confetti({ particleCount: 80, spread: 50, origin: { y: 0.7 }, colors: ['#ff007f', '#ffffff'] });
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
